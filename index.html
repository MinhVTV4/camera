<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Gear Hub - Quản lý cho thuê</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Flatpickr Date Picker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .flatpickr-calendar { background-color: #374151; border-color: #4b5563; }
        .flatpickr-day { color: #d1d5db; }
        .flatpickr-day:hover { background-color: #4b5563; }
        .flatpickr-day.selected { background-color: #3b82f6; border-color: #3b82f6; }
        .flatpickr-time input.flatpickr-hour, .flatpickr-time input.flatpickr-minute { color: #d1d5db !important; }
        .numInputWrapper span { border-color: #d1d5db !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center"><svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-lg">Đang tải ứng dụng...</p></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="hidden">
        <div id="login-page" class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-xl p-8"><h2 class="text-3xl font-bold text-center text-white mb-2">Đăng Nhập</h2><p class="text-center text-gray-400 mb-8">Chào mừng trở lại!</p><form id="login-form"><div class="mb-4"><label for="login-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="login-email" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required></div><div class="mb-6"><label for="login-password" class="block text-gray-300 mb-2">Mật khẩu</label><input type="password" id="login-password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required></div><p id="login-error" class="text-red-400 text-sm mb-4 text-center"></p><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-300">Đăng Nhập</button></form><p class="text-center mt-6 text-gray-400">Chưa có tài khoản? <a href="#" id="show-register" class="text-blue-400 hover:underline">Tạo tài khoản</a></p></div></div>
        <div id="register-page" class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-xl p-8"><h2 class="text-3xl font-bold text-center text-white mb-2">Tạo Tài Khoản</h2><p class="text-center text-gray-400 mb-8">Bắt đầu quản lý thiết bị của bạn.</p><form id="register-form"><div class="mb-4"><label for="register-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="register-email" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required></div><div class="mb-6"><label for="register-password" class="block text-gray-300 mb-2">Mật khẩu</label><input type="password" id="register-password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required></div><p id="register-error" class="text-red-400 text-sm mb-4 text-center"></p><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-300">Đăng Ký</button></form><p class="text-center mt-6 text-gray-400">Đã có tài khoản? <a href="#" id="show-login" class="text-blue-400 hover:underline">Đăng nhập ngay</a></p></div></div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="hidden"><div class="relative md:flex w-full h-screen">
        <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col"><div class="flex items-center justify-center h-20 border-b border-gray-700"><svg class="h-8 w-8 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="text-2xl font-bold">GearHub</span></div><nav id="main-nav" class="flex-grow px-4 py-4"><a href="#dashboard" class="nav-link flex items-center px-4 py-3 rounded-lg"><svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>Dashboard</a><a href="#equipment" class="nav-link flex items-center px-4 py-3 mt-2 rounded-lg"><svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"></path></svg>Thiết bị</a><a href="#customers" class="nav-link flex items-center px-4 py-3 mt-2 rounded-lg"><svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Khách hàng</a><a href="#rentals" class="nav-link flex items-center px-4 py-3 mt-2 rounded-lg"><svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>Đơn thuê</a></nav><div class="px-4 py-4 border-t border-gray-700"><button id="logout-button" class="w-full flex items-center justify-center px-4 py-3 text-red-400 hover:bg-red-500 hover:text-white rounded-lg transition-colors"><svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Đăng xuất</button></div></aside>
        <div class="flex-1 flex flex-col"><header class="bg-gray-800 shadow-md md:hidden flex items-center justify-between p-4"><button id="sidebar-toggle" class="text-gray-300 hover:text-white focus:outline-none"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button><div id="header-title" class="text-xl font-bold">Dashboard</div><div></div></header>
            <main class="flex-1 p-6 lg:p-8 bg-gray-900 overflow-y-auto">
                <div id="dashboard-page" class="page-content">
                    <h1 class="text-3xl font-bold text-white mb-6">Tổng quan</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Doanh thu hôm nay</h3><p id="revenue-today" class="text-3xl font-bold text-green-400 mt-2">0 VNĐ</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Doanh thu tuần này</h3><p id="revenue-week" class="text-3xl font-bold text-green-400 mt-2">0 VNĐ</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Doanh thu tháng này</h3><p id="revenue-month" class="text-3xl font-bold text-green-400 mt-2">0 VNĐ</p></div>
                        <div class="bg-red-900/50 border border-red-700 p-6 rounded-xl shadow-lg"><h3 class="text-red-300 text-sm font-medium">Đơn hàng quá hạn</h3><p id="overdue-count" class="text-3xl font-bold text-red-400 mt-2">0</p></div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Thiết bị sẵn có</h3><p id="available-count" class="text-3xl font-bold text-white mt-2">0</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Thiết bị đang thuê</h3><p id="rented-count" class="text-3xl font-bold text-white mt-2">0</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Tổng số khách hàng</h3><p id="customer-count" class="text-3xl font-bold text-white mt-2">0</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Tổng số thiết bị</h3><p id="total-count" class="text-3xl font-bold text-white mt-2">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold text-white mb-4">Cảnh báo: Đơn hàng quá hạn</h2><div id="overdue-orders-list" class="space-y-4"></div></div>
                        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold text-white mb-4">Đơn sắp đến hạn trả</h2><div id="upcoming-returns-list" class="space-y-4"></div></div>
                        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold text-white mb-4">Hoạt động gần đây</h2><div id="recent-activity-list" class="space-y-3"></div></div>
                    </div>
                </div>
                <div id="equipment-page" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h1 class="text-3xl font-bold text-white">Quản lý Thiết bị</h1><button id="add-equipment-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center sm:w-auto w-full"><svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Thêm thiết bị</button></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6"><div id="equipment-filters" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div></div>
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto hidden md:block"><table class="w-full text-left min-w-[720px]"><thead class="bg-gray-700"><tr><th class="p-4 font-semibold">Tên thiết bị</th><th class="p-4 font-semibold">S/N</th><th class="p-4 font-semibold">Loại</th><th class="p-4 font-semibold">Trạng thái</th><th class="p-4 font-semibold text-right">Giá thuê/ngày</th><th class="p-4 font-semibold text-center">Hành động</th></tr></thead><tbody id="equipment-table-body"></tbody></table></div>
                    <div id="equipment-list-mobile" class="md:hidden space-y-4"></div>
                </div>
                <div id="customers-page" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h1 class="text-3xl font-bold text-white">Quản lý Khách hàng</h1><button id="add-customer-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center sm:w-auto w-full"><svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Thêm khách hàng</button></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6"><div id="customer-filters" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div></div>
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto hidden md:block"><table class="w-full text-left min-w-[720px]"><thead class="bg-gray-700"><tr><th class="p-4 font-semibold">Họ và tên</th><th class="p-4 font-semibold">Số điện thoại</th><th class="p-4 font-semibold">Email</th><th class="p-4 font-semibold">Số CCCD</th><th class="p-4 font-semibold text-center">Hành động</th></tr></thead><tbody id="customer-table-body"></tbody></table></div>
                    <div id="customer-list-mobile" class="md:hidden space-y-4"></div>
                </div>
                <div id="rentals-page" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h1 class="text-3xl font-bold text-white">Quản lý Đơn thuê</h1><button id="add-rental-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center sm:w-auto w-full"><svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tạo đơn thuê</button></div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6"><div id="rental-filters" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div></div>
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto hidden md:block"><table class="w-full text-left min-w-[720px]"><thead class="bg-gray-700"><tr><th class="p-4 font-semibold">Khách hàng</th><th class="p-4 font-semibold">Ngày thuê</th><th class="p-4 font-semibold">Ngày trả</th><th class="p-4 font-semibold">Trạng thái</th><th class="p-4 font-semibold text-right">Tổng tiền</th><th class="p-4 font-semibold text-center">Hành động</th></tr></thead><tbody id="rental-table-body"></tbody></table></div>
                    <div id="rental-list-mobile" class="md:hidden space-y-4"></div>
                </div>
            </main>
        </div><div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-30 hidden md:hidden"></div>
    </div></div>

    <!-- Modals -->
    <div id="equipment-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-8 transform transition-all scale-95" id="equipment-modal-content"><div class="flex justify-between items-center mb-6"><h2 id="modal-title" class="text-2xl font-bold text-white"></h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><form id="equipment-form"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="eq-name" class="block text-gray-300 mb-2">Tên thiết bị</label><input type="text" id="eq-name" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" required></div><div><label for="eq-brand" class="block text-gray-300 mb-2">Hãng</label><input type="text" id="eq-brand" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" required></div><div><label for="eq-serial" class="block text-gray-300 mb-2">Serial Number (S/N)</label><input type="text" id="eq-serial" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" required></div><div><label for="eq-type" class="block text-gray-300 mb-2">Loại thiết bị</label><select id="eq-type" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"><option>Máy ảnh</option><option>Ống kính</option><option>Tripod</option><option>Đèn</option><option>Micro</option><option>Thẻ nhớ</option><option>Khác</option></select></div><div class="md:col-span-2"><label for="eq-rate" class="block text-gray-300 mb-2">Giá thuê / ngày (VNĐ)</label><input type="number" id="eq-rate" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" required></div></div><p id="equipment-form-error" class="text-red-400 text-sm mt-4 text-center"></p><div class="mt-8 flex justify-end"><button type="button" id="cancel-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg mr-4">Hủy</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Lưu</button></div></form></div></div>
    <div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-8 transform transition-all scale-95" id="customer-modal-content"><div class="flex justify-between items-center mb-6"><h2 id="customer-modal-title" class="text-2xl font-bold text-white"></h2><button id="close-customer-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><form id="customer-form"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="cus-name" class="block text-gray-300 mb-2">Họ và tên</label><input type="text" id="cus-name" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" required></div><div><label for="cus-phone" class="block text-gray-300 mb-2">Số điện thoại</label><input type="tel" id="cus-phone" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" required></div><div><label for="cus-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="cus-email" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"></div><div><label for="cus-idcard" class="block text-gray-300 mb-2">Số CCCD/CMND</label><input type="text" id="cus-idcard" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"></div></div><p id="customer-form-error" class="text-red-400 text-sm mt-4 text-center"></p><div class="mt-8 flex justify-end"><button type="button" id="cancel-customer-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg mr-4">Hủy</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Lưu</button></div></form></div></div>
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-8 transform transition-all scale-95"><h3 class="text-xl font-bold text-white mb-4">Xác nhận xóa</h3><p class="text-gray-400 mb-6">Bạn có chắc chắn muốn xóa <strong id="item-to-delete-name" class="font-bold text-amber-400"></strong>? Hành động này không thể hoàn tác.</p><div class="flex justify-end gap-4"><button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Hủy</button><button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Xóa</button></div></div></div>
    <div id="rental-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl p-8 transform transition-all scale-95 flex flex-col h-[90vh]"><div class="flex justify-between items-center mb-6 flex-shrink-0"><h2 class="text-2xl font-bold text-white">Tạo đơn thuê mới</h2><button id="close-rental-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><div class="flex-grow overflow-y-auto pr-2"><form id="rental-form"><div class="mb-6"><h3 class="text-lg font-semibold text-blue-400 border-b border-gray-700 pb-2 mb-4">1. Thông tin khách hàng</h3><div class="relative"><label for="customer-search" class="block text-gray-300 mb-2">Tìm khách hàng (theo tên hoặc SĐT)</label><input type="text" id="customer-search" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" autocomplete="off"><div id="customer-search-results" class="absolute w-full bg-gray-600 rounded-md mt-1 z-10 max-h-48 overflow-y-auto hidden"></div></div><div id="selected-customer-info" class="mt-4 p-4 bg-gray-700/50 rounded-lg hidden"></div></div><div class="mb-6"><h3 class="text-lg font-semibold text-blue-400 border-b border-gray-700 pb-2 mb-4">2. Thêm thiết bị</h3><label for="equipment-search" class="block text-gray-300 mb-2">Nhập Serial Number và nhấn Thêm</label><div class="flex gap-2"><input type="text" id="equipment-search" class="flex-grow p-3 bg-gray-700 rounded-md border border-gray-600" autocomplete="off"><button type="button" id="add-equipment-to-cart-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Thêm</button></div><p id="equipment-search-error" class="text-red-400 text-sm mt-1"></p><div id="rental-cart" class="mt-4 space-y-2"></div></div><div class="mb-6"><h3 class="text-lg font-semibold text-blue-400 border-b border-gray-700 pb-2 mb-4">3. Thời gian & Chi phí</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="start-date" class="block text-gray-300 mb-2">Ngày thuê</label><input type="text" id="start-date" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 cursor-pointer" readonly></div><div><label for="end-date" class="block text-gray-300 mb-2">Ngày trả</label><input type="text" id="end-date" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 cursor-pointer" readonly></div></div><div id="rental-summary" class="mt-4 p-4 bg-gray-700/50 rounded-lg hidden"><div class="flex justify-between items-center"><span class="text-gray-400">Tổng số ngày thuê:</span><span id="rental-days" class="font-semibold text-white">0 ngày</span></div><div class="flex justify-between items-center mt-2"><span class="text-gray-400 text-xl">Tổng chi phí:</span><span id="rental-total-cost" class="font-bold text-2xl text-green-400">0 VNĐ</span></div></div></div></form></div><div class="mt-8 flex justify-end flex-shrink-0"><button type="button" id="cancel-rental-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg mr-4">Hủy</button><button type="submit" id="save-rental-btn" form="rental-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Lưu đơn thuê</button></div></div></div>
    <div id="confirm-return-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl p-8 transform transition-all scale-95"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Xác nhận trả hàng</h2><button id="close-return-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><form id="return-form"><div id="return-info" class="space-y-4"></div><div class="mt-6 border-t border-gray-700 pt-6 space-y-4"><h3 class="text-lg font-semibold text-blue-400">Điều chỉnh chi phí (nếu có)</h3><div><label for="adjustment-amount" class="block text-gray-300 mb-2">Giảm giá (-)/ Phụ thu (+)</label><input type="number" id="adjustment-amount" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" placeholder="VD: -50000 hoặc 100000"></div><div><label for="adjustment-notes" class="block text-gray-300 mb-2">Ghi chú điều chỉnh</label><textarea id="adjustment-notes" rows="2" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"></textarea></div><div class="p-4 bg-gray-900 rounded-lg"><label for="final-cost" class="block text-green-400 mb-2 font-semibold">TỔNG THU CUỐI CÙNG (VNĐ)</label><input type="number" id="final-cost" class="w-full p-3 bg-gray-700 text-2xl font-bold text-green-300 rounded-md border border-gray-600"></div></div><p id="return-form-error" class="text-red-400 text-sm mt-4 text-center"></p><div class="mt-8 flex justify-end"><button type="button" id="cancel-return-modal-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg mr-4">Hủy</button><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Xác nhận & Hoàn tất</button></div></form></div></div>
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-8 transform transition-all scale-95"><div class="flex justify-between items-center mb-6"><h2 id="details-modal-title" class="text-2xl font-bold text-white"></h2><button id="close-details-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><div id="details-modal-content" class="space-y-3 text-gray-300"></div><div id="details-modal-actions" class="mt-6 border-t border-gray-700 pt-4"></div></div></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, where, getDocs, doc, getDoc, updateDoc, deleteDoc, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCx5bdVV6suNdO0UcyERAwbNHBFj2xgzwE", authDomain: "lamthuy.firebaseapp.com", projectId: "lamthuy", storageBucket: "lamthuy.appspot.com", messagingSenderId: "326127588046", appId: "1:326127588046:web:040bab99b771b081d9b69f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const authContainer = document.getElementById('auth-container');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register'), showLoginLink = document.getElementById('show-login');
        const loginErrorEl = document.getElementById('login-error'), registerErrorEl = document.getElementById('register-error');
        const logoutButton = document.getElementById('logout-button');
        const sidebarToggle = document.getElementById('sidebar-toggle'), sidebar = document.getElementById('sidebar'), sidebarOverlay = document.getElementById('sidebar-overlay');
        const mainNav = document.getElementById('main-nav'), headerTitle = document.getElementById('header-title');
        
        // Modals
        const equipmentModal = document.getElementById('equipment-modal'), customerModal = document.getElementById('customer-modal'), confirmDeleteModal = document.getElementById('confirm-delete-modal'), rentalModal = document.getElementById('rental-modal'), confirmReturnModal = document.getElementById('confirm-return-modal'), detailsModal = document.getElementById('details-modal');
        const equipmentModalContent = document.getElementById('equipment-modal-content'), customerModalContent = document.getElementById('customer-modal-content');
        
        // Dashboard
        const revenueTodayEl = document.getElementById('revenue-today'), revenueWeekEl = document.getElementById('revenue-week'), revenueMonthEl = document.getElementById('revenue-month'), overdueCountEl = document.getElementById('overdue-count');
        const overdueOrdersList = document.getElementById('overdue-orders-list'), upcomingReturnsList = document.getElementById('upcoming-returns-list');
        const recentActivityList = document.getElementById('recent-activity-list');
        const availableCountEl = document.getElementById('available-count'), rentedCountEl = document.getElementById('rented-count'), customerCountEl = document.getElementById('customer-count'), totalCountEl = document.getElementById('total-count');

        // Equipment Elements
        const addEquipmentBtn = document.getElementById('add-equipment-btn');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn'), cancelModalBtn = document.getElementById('cancel-modal-btn');
        const equipmentForm = document.getElementById('equipment-form'), equipmentTableBody = document.getElementById('equipment-table-body'), equipmentFormError = document.getElementById('equipment-form-error');
        const equipmentListMobile = document.getElementById('equipment-list-mobile');
        
        // Customer Elements
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const customerModalTitle = document.getElementById('customer-modal-title');
        const closeCustomerModalBtn = document.getElementById('close-customer-modal-btn'), cancelCustomerModalBtn = document.getElementById('cancel-customer-modal-btn');
        const customerForm = document.getElementById('customer-form'), customerTableBody = document.getElementById('customer-table-body'), customerFormError = document.getElementById('customer-form-error');
        const customerListMobile = document.getElementById('customer-list-mobile');

        // Delete Modal Elements
        const itemToDeleteName = document.getElementById('item-to-delete-name');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn'), confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // Rental Page
        const addRentalBtn = document.getElementById('add-rental-btn');
        const rentalTableBody = document.getElementById('rental-table-body');
        const rentalListMobile = document.getElementById('rental-list-mobile');
        const rentalForm = document.getElementById('rental-form');
        const customerSearchInput = document.getElementById('customer-search'), customerSearchResults = document.getElementById('customer-search-results'), selectedCustomerInfo = document.getElementById('selected-customer-info');
        const equipmentSearchInput = document.getElementById('equipment-search'), equipmentSearchError = document.getElementById('equipment-search-error'), addEquipmentToCartBtn = document.getElementById('add-equipment-to-cart-btn');
        const rentalCartDiv = document.getElementById('rental-cart');
        const startDateInput = document.getElementById('start-date'), endDateInput = document.getElementById('end-date');
        const rentalSummaryDiv = document.getElementById('rental-summary'), rentalDaysEl = document.getElementById('rental-days'), rentalTotalCostEl = document.getElementById('rental-total-cost');
        const saveRentalBtn = document.getElementById('save-rental-btn');

        // Return Modal Elements
        const returnInfoDiv = document.getElementById('return-info');
        const returnForm = document.getElementById('return-form');
        const adjustmentAmountInput = document.getElementById('adjustment-amount');
        const adjustmentNotesInput = document.getElementById('adjustment-notes');
        const finalCostInput = document.getElementById('final-cost');
        const returnFormError = document.getElementById('return-form-error');

        // --- App State ---
        let listeners = { equipment: null, customer: null, rental: null, dashboardRentals: null, dashboardActivity: null, dashboardEquipment: null, dashboardCustomers: null };
        let currentEditId = null, currentCustomerEditId = null;
        let itemToDeleteId = null, itemToDeleteType = '';
        let rentalState = { customer: null, items: [], startDate: null, endDate: null, totalCost: 0, days: 0 };
        let datePickerStart, datePickerEnd;
        let activeReturnData = null;

        // --- UI / View Management ---
        function updateUI(state) {
            loadingIndicator.classList.add('hidden'); authContainer.classList.add('hidden'); appView.classList.add('hidden'); document.getElementById('login-page').classList.add('hidden'); document.getElementById('register-page').classList.add('hidden');
            if (state === 'loading') { loadingIndicator.classList.remove('hidden'); } 
            else if (state === 'login') { authContainer.classList.remove('hidden'); document.getElementById('login-page').classList.remove('hidden'); } 
            else if (state === 'register') { authContainer.classList.remove('hidden'); document.getElementById('register-page').classList.remove('hidden'); } 
            else if (state === 'app') { appView.classList.remove('hidden'); }
        }

        function navigateToPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(link => { link.classList.remove('bg-gray-700', 'text-white'); link.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white'); if (link.getAttribute('href') === `#${pageId}`) { link.classList.add('bg-gray-700', 'text-white'); link.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white'); headerTitle.textContent = link.textContent.trim(); } });
            Object.keys(listeners).forEach(key => { if (listeners[key]) { listeners[key](); listeners[key] = null; } });
            if (pageId === 'dashboard') loadDashboardData();
            else if (pageId === 'equipment') loadEquipmentPageData(); 
            else if (pageId === 'customers') loadCustomers();
            else if (pageId === 'rentals') loadRentals();
        }
        mainNav.addEventListener('click', (e) => { const link = e.target.closest('.nav-link'); if (link) { e.preventDefault(); const pageId = link.getAttribute('href').substring(1); navigateToPage(pageId); if (window.innerWidth < 768) { toggleSidebar(); } } });

        onAuthStateChanged(auth, (user) => {
            if (user) { updateUI('app'); navigateToPage('dashboard'); } 
            else { updateUI('login'); Object.keys(listeners).forEach(key => { if (listeners[key]) { listeners[key](); listeners[key] = null; } }); }
        });
        
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
        const formatDate = (timestamp, includeTime = false) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            const options = includeTime ? { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' } : { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleString('vi-VN', options);
        }
        const getStatusClass = (status, type = 'equipment') => {
            const classes = {
                equipment: { 'Sẵn có': 'bg-green-500/20 text-green-400', 'Đang được thuê': 'bg-yellow-500/20 text-yellow-400', 'Đã đặt trước': 'bg-orange-500/20 text-orange-400', 'Bảo trì': 'bg-purple-500/20 text-purple-400' },
                rental: { 'Chờ lấy hàng': 'bg-orange-500/20 text-orange-400', 'Đang thuê': 'bg-yellow-500/20 text-yellow-400', 'Đã trả': 'bg-green-500/20 text-green-400', 'Quá hạn': 'bg-red-500/20 text-red-400' }
            };
            return classes[type][status] || 'bg-gray-500/20 text-gray-400';
        };
        const renderActionButtons = (id, name) => `<button class="edit-btn p-2 text-blue-400 hover:text-blue-300" data-id="${id}" title="Sửa"><svg class="h-5 w-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button><button class="delete-btn p-2 text-red-500 hover:text-red-400" data-id="${id}" data-name="${name}" title="Xóa"><svg class="h-5 w-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
        async function logActivity(text) { try { await addDoc(collection(db, 'activity_logs'), { text, timestamp: serverTimestamp() }); } catch (error) { console.error("Error logging activity: ", error); } }

        // --- Dashboard Management ---
        function loadDashboardData() {
            Object.keys(listeners).forEach(key => { if (listeners[key]) { listeners[key](); listeners[key] = null; } });

            listeners.dashboardRentals = onSnapshot(query(collection(db, 'rentals')), (snapshot) => {
                const now = new Date();
                const startOfToday = new Date(); startOfToday.setHours(0, 0, 0, 0);
                const endOfTomorrow = new Date(); endOfTomorrow.setDate(now.getDate() + 1); endOfTomorrow.setHours(23, 59, 59, 999);
                const startOfWeek = new Date(startOfToday); startOfWeek.setDate(startOfToday.getDate() - startOfToday.getDay() + (startOfToday.getDay() === 0 ? -6 : 1));
                const startOfMonth = new Date(startOfToday.getFullYear(), startOfToday.getMonth(), 1);

                let revenueToday = 0, revenueWeek = 0, revenueMonth = 0;
                const overdueOrders = [], upcomingReturns = [];

                snapshot.docs.forEach(doc => {
                    const rental = doc.data(); rental.id = doc.id;
                    if (rental.status === 'Đã trả' && rental.returnedDate) {
                        const returnedDate = rental.returnedDate.toDate();
                        const costValue = rental.actualCost !== undefined ? rental.actualCost : rental.totalCost;
                        const cost = !isNaN(parseFloat(costValue)) ? parseFloat(costValue) : 0;
                        if (returnedDate >= startOfToday) revenueToday += cost;
                        if (returnedDate >= startOfWeek) revenueWeek += cost;
                        if (returnedDate >= startOfMonth) revenueMonth += cost;
                    }
                    if (rental.status === 'Đang thuê') {
                        const endDate = rental.endDate.toDate();
                        if (endDate < now) { rental.daysOverdue = Math.ceil((now - endDate) / (1000 * 60 * 60 * 24)); overdueOrders.push(rental); } 
                        else if (endDate <= endOfTomorrow) { upcomingReturns.push(rental); }
                    }
                });

                revenueTodayEl.textContent = formatCurrency(revenueToday);
                revenueWeekEl.textContent = formatCurrency(revenueWeek);
                revenueMonthEl.textContent = formatCurrency(revenueMonth);
                overdueCountEl.textContent = overdueOrders.length;
                renderOverdueOrders(overdueOrders);
                renderUpcomingReturns(upcomingReturns.sort((a,b) => a.endDate.toDate() - b.endDate.toDate()));
            });

            listeners.dashboardEquipment = onSnapshot(collection(db, 'equipment'), (snapshot) => {
                let available = 0, rented = 0;
                snapshot.docs.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'Sẵn có') available++;
                    if (status === 'Đang được thuê' || status === 'Đã đặt trước') rented++;
                });
                availableCountEl.textContent = available;
                rentedCountEl.textContent = rented;
                totalCountEl.textContent = snapshot.size;
            });

            listeners.dashboardCustomers = onSnapshot(collection(db, 'customers'), (snapshot) => { customerCountEl.textContent = snapshot.size; });
            listeners.dashboardActivity = onSnapshot(query(collection(db, 'activity_logs'), orderBy('timestamp', 'desc'), limit(5)), (snapshot) => renderRecentActivity(snapshot.docs));
        }

        function renderOverdueOrders(orders) {
            if (orders.length === 0) { overdueOrdersList.innerHTML = `<p class="text-gray-400">Không có đơn hàng nào quá hạn.</p>`; return; }
            overdueOrdersList.innerHTML = orders.map(order => `<div class="bg-red-900/40 p-3 rounded-lg border border-red-700/50"><div class="flex justify-between items-start"><div><p class="font-bold text-white">${order.customer.name}</p><p class="text-sm text-gray-300">${order.customer.phone}</p></div><div class="text-right"><p class="font-bold text-red-400">Quá hạn ${order.daysOverdue} ngày</p><p class="text-xs text-gray-400">Hạn trả: ${formatDate(order.endDate)}</p></div></div></div>`).join('');
        }

        function renderUpcomingReturns(orders) {
            if (orders.length === 0) { upcomingReturnsList.innerHTML = `<p class="text-gray-400">Không có đơn nào sắp đến hạn.</p>`; return; }
            upcomingReturnsList.innerHTML = orders.map(order => { const endDate = order.endDate.toDate(); const isToday = endDate.toDateString() === new Date().toDateString(); return `<div class="bg-gray-700/50 p-3 rounded-lg"><p class="font-semibold text-white">${order.customer.name}</p><p class="text-sm text-gray-300">Hạn trả: <span class="${isToday ? 'text-amber-400 font-bold' : ''}">${formatDate(order.endDate, true)}</span></p></div>` }).join('');
        }

        function renderRecentActivity(activities) {
            if (activities.length === 0) { recentActivityList.innerHTML = `<p class="text-gray-400">Chưa có hoạt động nào.</p>`; return; }
            recentActivityList.innerHTML = activities.map(actDoc => { const activity = actDoc.data(); return `<div class="border-l-2 border-blue-500 pl-3"><p class="text-sm text-gray-200">${activity.text}</p><p class="text-xs text-gray-500">${formatDate(activity.timestamp, true)}</p></div>`; }).join('');
        }

        // --- Equipment Management ---
        let equipmentData = [];
        let activeRentalsMap = new Map();

        function loadEquipmentPageData() {
            if (listeners.equipment) listeners.equipment();
            if (listeners.rental) listeners.rental();

            listeners.rental = onSnapshot(query(collection(db, 'rentals'), where('status', 'in', ['Đang thuê', 'Chờ lấy hàng'])), (snapshot) => {
                activeRentalsMap.clear();
                snapshot.forEach(doc => {
                    const rental = doc.data();
                    rental.items.forEach(item => {
                        activeRentalsMap.set(item.serialNumber, rental.endDate);
                    });
                });
                renderEquipmentViews(equipmentData, activeRentalsMap);
            });

            listeners.equipment = onSnapshot(collection(db, 'equipment'), (snapshot) => {
                equipmentData = snapshot.docs;
                renderEquipmentViews(equipmentData, activeRentalsMap);
            });
        }

        function renderEquipmentViews(docs, rentalsMap) {
            let tableHTML = '';
            let mobileHTML = '';

            if (docs.length === 0) {
                const emptyRow = `<tr><td colspan="6" class="text-center p-8 text-gray-400">Chưa có thiết bị nào.</td></tr>`;
                equipmentTableBody.innerHTML = emptyRow;
                equipmentListMobile.innerHTML = `<div class="text-center p-8 text-gray-400">Chưa có thiết bị nào.</div>`;
                return;
            }
            
            docs.forEach(doc => {
                const eq = doc.data();
                const statusClass = getStatusClass(eq.status, 'equipment');
                let statusText = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${eq.status}</span>`;
                let returnDateText = '';
                
                if ((eq.status === 'Đang được thuê' || eq.status === 'Đã đặt trước') && rentalsMap.has(eq.serialNumber)) {
                    returnDateText = `<p class="text-xs text-gray-400 mt-1">Trả: ${formatDate(rentalsMap.get(eq.serialNumber))}</p>`;
                }
                const statusHTML = statusText + returnDateText;

                tableHTML += `<tr class="border-b border-gray-700 hover:bg-gray-700/50"><td class="p-4 font-medium">${eq.name}</td><td class="p-4 text-gray-400">${eq.serialNumber}</td><td class="p-4 text-gray-400">${eq.type}</td><td class="p-4">${statusHTML}</td><td class="p-4 text-right text-gray-300">${formatCurrency(eq.dailyRate)}</td><td class="p-4 text-center">${renderActionButtons(doc.id, eq.name)}</td></tr>`;

                mobileHTML += `<div class="bg-gray-800 rounded-lg shadow-md p-4 list-card" data-type="equipment" data-id="${doc.id}"><div class="flex justify-between items-start"><div class="flex-grow"><p class="font-bold text-white">${eq.name}</p><p class="text-sm text-gray-400">S/N: ${eq.serialNumber}</p></div><div class="flex-shrink-0 ml-4">${statusText}</div></div><div class="mt-2 text-xs text-gray-400">${returnDateText}</div><div class="mt-4 flex justify-between items-center"><p class="text-green-400 font-semibold">${formatCurrency(eq.dailyRate)}<span class="text-gray-400 font-normal">/ngày</span></p><div class="flex items-center space-x-2">${renderActionButtons(doc.id, eq.name)}</div></div></div>`;
            });

            equipmentTableBody.innerHTML = tableHTML;
            equipmentListMobile.innerHTML = mobileHTML;
        }

        equipmentListMobile.addEventListener('click', async (e) => {
            const card = e.target.closest('.list-card');
            const isActionButton = e.target.closest('.edit-btn') || e.target.closest('.delete-btn');
            if (card && !isActionButton) {
                const id = card.dataset.id;
                const docRef = doc(db, 'equipment', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const eq = docSnap.data();
                    let returnDateHTML = '';
                    if ((eq.status === 'Đang được thuê' || eq.status === 'Đã đặt trước') && activeRentalsMap.has(eq.serialNumber)) {
                         returnDateHTML = `<div class="flex justify-between py-2 border-b border-gray-700"><span>Ngày trả dự kiến:</span><span class="font-semibold">${formatDate(activeRentalsMap.get(eq.serialNumber))}</span></div>`;
                    }
                    const content = `
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Tên thiết bị:</span><span class="font-semibold">${eq.name}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Hãng:</span><span class="font-semibold">${eq.brand}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Serial Number:</span><span class="font-semibold">${eq.serialNumber}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Loại:</span><span class="font-semibold">${eq.type}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Giá thuê/ngày:</span><span class="font-semibold">${formatCurrency(eq.dailyRate)}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Trạng thái:</span><span class="font-semibold">${eq.status}</span></div>
                        ${returnDateHTML}
                    `;
                    openDetailsModal('Chi tiết thiết bị', content);
                }
            }
        });
        
        equipmentTableBody.addEventListener('click', async (e) => { const editBtn = e.target.closest('.edit-btn'); const deleteBtn = e.target.closest('.delete-btn'); if (editBtn) { const docSnap = await getDoc(doc(db, 'equipment', editBtn.dataset.id)); if (docSnap.exists()) openEquipmentModal('edit', docSnap.data(), docSnap.id); } if (deleteBtn) { openDeleteConfirmation(deleteBtn.dataset.id, deleteBtn.dataset.name, 'equipment'); } });
        equipmentForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('eq-name').value.trim(), brand = document.getElementById('eq-brand').value.trim(), serialNumber = document.getElementById('eq-serial').value.trim().toUpperCase(), type = document.getElementById('eq-type').value, dailyRate = Number(document.getElementById('eq-rate').value); equipmentFormError.textContent = ''; if (!name || !brand || !serialNumber || !dailyRate) { equipmentFormError.textContent = 'Vui lòng điền đủ các trường.'; return; } try { if (currentEditId) { await updateDoc(doc(db, 'equipment', currentEditId), { name, brand, type, dailyRate }); logActivity(`Đã cập nhật thiết bị: ${name}`); } else { const q = query(collection(db, "equipment"), where("serialNumber", "==", serialNumber)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { equipmentFormError.textContent = 'Serial Number này đã tồn tại.'; return; } await addDoc(collection(db, 'equipment'), { name, brand, serialNumber, type, dailyRate, status: 'Sẵn có', createdAt: serverTimestamp() }); logActivity(`Đã thêm thiết bị mới: ${name}`); } closeEquipmentModal(); } catch (error) { console.error(error); equipmentFormError.textContent = 'Đã có lỗi xảy ra.'; } });
        function openEquipmentModal(mode = 'add', data = {}, id = null) { equipmentForm.reset(); equipmentFormError.textContent = ''; currentEditId = null; const serialInput = document.getElementById('eq-serial'); if (mode === 'edit') { modalTitle.textContent = 'Cập nhật thiết bị'; currentEditId = id; document.getElementById('eq-name').value = data.name; document.getElementById('eq-brand').value = data.brand; serialInput.value = data.serialNumber; serialInput.disabled = true; serialInput.classList.add('bg-gray-600', 'cursor-not-allowed'); document.getElementById('eq-type').value = data.type; document.getElementById('eq-rate').value = data.dailyRate; } else { modalTitle.textContent = 'Thêm thiết bị mới'; serialInput.disabled = false; serialInput.classList.remove('bg-gray-600', 'cursor-not-allowed'); } equipmentModal.classList.remove('hidden'); equipmentModal.classList.add('flex'); setTimeout(() => equipmentModalContent.classList.add('scale-100'), 10); }
        function closeEquipmentModal() { equipmentModalContent.classList.remove('scale-100'); setTimeout(() => { equipmentModal.classList.add('hidden'); equipmentModal.classList.remove('flex'); equipmentModalContent.classList.add('scale-95'); }, 200); }
        addEquipmentBtn.addEventListener('click', () => openEquipmentModal('add')); closeModalBtn.addEventListener('click', closeEquipmentModal); cancelModalBtn.addEventListener('click', closeEquipmentModal); equipmentModal.addEventListener('click', (e) => { if (e.target === equipmentModal) closeEquipmentModal(); });

        // --- Customer Management ---
        function loadCustomers() { if (listeners.customer) return; listeners.customer = onSnapshot(collection(db, 'customers'), (snapshot) => renderCustomerViews(snapshot.docs)); }
        function renderCustomerViews(docs) {
            let tableHTML = '';
            let mobileHTML = '';
            if (docs.length === 0) {
                customerTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">Chưa có khách hàng nào.</td></tr>`;
                customerListMobile.innerHTML = `<div class="text-center p-8 text-gray-400">Chưa có khách hàng nào.</div>`;
                return;
            }
            docs.forEach(doc => {
                const cus = doc.data();
                tableHTML += `<tr class="border-b border-gray-700 hover:bg-gray-700/50"><td class="p-4 font-medium">${cus.fullName}</td><td class="p-4 text-gray-400">${cus.phone}</td><td class="p-4 text-gray-400">${cus.email || 'N/A'}</td><td class="p-4 text-gray-400">${cus.idCard || 'N/A'}</td><td class="p-4 text-center">${renderActionButtons(doc.id, cus.fullName)}</td></tr>`;
                mobileHTML += `<div class="bg-gray-800 rounded-lg shadow-md p-4 list-card" data-type="customer" data-id="${doc.id}"><div class="flex justify-between items-start"><div class="flex-grow"><p class="font-bold text-white">${cus.fullName}</p><p class="text-sm text-gray-400">${cus.phone}${cus.email ? ` | ${cus.email}` : ''}</p></div><div class="flex-shrink-0 ml-2 flex items-center space-x-2">${renderActionButtons(doc.id, cus.fullName)}</div></div></div>`;
            });
            customerTableBody.innerHTML = tableHTML;
            customerListMobile.innerHTML = mobileHTML;
        }
        customerListMobile.addEventListener('click', async (e) => {
            const card = e.target.closest('.list-card');
            const isActionButton = e.target.closest('.edit-btn') || e.target.closest('.delete-btn');
            if (card && !isActionButton) {
                const id = card.dataset.id;
                const docRef = doc(db, 'customers', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const cus = docSnap.data();
                    const content = `
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Họ và tên:</span><span class="font-semibold">${cus.fullName}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Số điện thoại:</span><span class="font-semibold">${cus.phone}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Email:</span><span class="font-semibold">${cus.email || 'N/A'}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Số CCCD:</span><span class="font-semibold">${cus.idCard || 'N/A'}</span></div>
                    `;
                    openDetailsModal('Chi tiết khách hàng', content, 'customer', id, cus.fullName);
                }
            }
        });
        customerTableBody.addEventListener('click', async (e) => { const editBtn = e.target.closest('.edit-btn'); const deleteBtn = e.target.closest('.delete-btn'); if (editBtn) { const docSnap = await getDoc(doc(db, 'customers', editBtn.dataset.id)); if (docSnap.exists()) openCustomerModal('edit', docSnap.data(), docSnap.id); } if (deleteBtn) { openDeleteConfirmation(deleteBtn.dataset.id, deleteBtn.dataset.name, 'customers'); } });
        customerForm.addEventListener('submit', async (e) => { e.preventDefault(); const fullName = document.getElementById('cus-name').value.trim(), phone = document.getElementById('cus-phone').value.trim(), email = document.getElementById('cus-email').value.trim(), idCard = document.getElementById('cus-idcard').value.trim(); customerFormError.textContent = ''; if (!fullName || !phone) { customerFormError.textContent = 'Vui lòng nhập Họ tên và Số điện thoại.'; return; } try { if (currentCustomerEditId) { await updateDoc(doc(db, 'customers', currentCustomerEditId), { fullName, email, idCard }); logActivity(`Đã cập nhật khách hàng: ${fullName}`); } else { const q = query(collection(db, "customers"), where("phone", "==", phone)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { customerFormError.textContent = 'Số điện thoại này đã tồn tại.'; return; } await addDoc(collection(db, 'customers'), { fullName, phone, email, idCard, createdAt: serverTimestamp() }); logActivity(`Đã thêm khách hàng: ${fullName}`); } closeCustomerModal(); } catch (error) { console.error(error); customerFormError.textContent = 'Đã có lỗi xảy ra.'; } });
        function openCustomerModal(mode = 'add', data = {}, id = null) { customerForm.reset(); customerFormError.textContent = ''; currentCustomerEditId = null; const phoneInput = document.getElementById('cus-phone'); if (mode === 'edit') { customerModalTitle.textContent = 'Cập nhật khách hàng'; currentCustomerEditId = id; document.getElementById('cus-name').value = data.fullName; phoneInput.value = data.phone; phoneInput.disabled = true; phoneInput.classList.add('bg-gray-600', 'cursor-not-allowed'); document.getElementById('cus-email').value = data.email || ''; document.getElementById('cus-idcard').value = data.idCard || ''; } else { customerModalTitle.textContent = 'Thêm khách hàng mới'; phoneInput.disabled = false; phoneInput.classList.remove('bg-gray-600', 'cursor-not-allowed'); } customerModal.classList.remove('hidden'); customerModal.classList.add('flex'); setTimeout(() => customerModalContent.classList.add('scale-100'), 10); }
        function closeCustomerModal() { customerModalContent.classList.remove('scale-100'); setTimeout(() => { customerModal.classList.add('hidden'); customerModal.classList.remove('flex'); customerModalContent.classList.add('scale-95'); }, 200); }
        addCustomerBtn.addEventListener('click', () => openCustomerModal('add')); closeCustomerModalBtn.addEventListener('click', closeCustomerModal); cancelCustomerModalBtn.addEventListener('click', closeCustomerModal); customerModal.addEventListener('click', (e) => { if (e.target === customerModal) closeCustomerModal(); });

        // --- Delete Confirmation Logic ---
        function openDeleteConfirmation(id, name, type) {
            itemToDeleteId = id; itemToDeleteType = type;
            itemToDeleteName.textContent = name;
            confirmDeleteModal.classList.remove('hidden'); confirmDeleteModal.classList.add('flex');
            setTimeout(() => confirmDeleteModal.querySelector('div').classList.add('scale-100'), 10);
        }
        function closeDeleteConfirmation() { confirmDeleteModal.querySelector('div').classList.remove('scale-100'); setTimeout(() => { confirmDeleteModal.classList.add('hidden'); confirmDeleteModal.classList.remove('flex'); confirmDeleteModal.querySelector('div').classList.add('scale-95'); }, 200); }
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmation);
        confirmDeleteModal.addEventListener('click', (e) => { if (e.target === confirmDeleteModal) closeDeleteConfirmation(); });
        confirmDeleteBtn.addEventListener('click', async () => {
            if (itemToDeleteId && itemToDeleteType) {
                try {
                    const docToDelete = await getDoc(doc(db, itemToDeleteType, itemToDeleteId));
                    const docName = docToDelete.data().name || docToDelete.data().fullName;
                    await deleteDoc(doc(db, itemToDeleteType, itemToDeleteId));
                    logActivity(`Đã xóa ${itemToDeleteType === 'equipment' ? 'thiết bị' : 'khách hàng'}: ${docName}`);
                    closeDeleteConfirmation();
                } catch (error) { console.error("Error deleting document:", error); alert("Có lỗi xảy ra khi xóa."); }
            }
        });

        // --- RENTAL MANAGEMENT ---
        function loadRentals() { if (listeners.rental) return; const q = query(collection(db, 'rentals')); listeners.rental = onSnapshot(q, (snapshot) => renderRentalViews(snapshot.docs)); }
        function renderRentalViews(docs) {
            let tableHTML = '';
            let mobileHTML = '';
            if (docs.length === 0) {
                const emptyRow = `<tr><td colspan="6" class="text-center p-8 text-gray-400">Chưa có đơn thuê nào.</td></tr>`;
                rentalTableBody.innerHTML = emptyRow;
                rentalListMobile.innerHTML = `<div class="text-center p-8 text-gray-400">Chưa có đơn thuê nào.</div>`;
                return;
            }
            docs.forEach(doc => {
                const rental = doc.data();
                const statusClass = getStatusClass(rental.status, 'rental');
                let actions = '';
                if (rental.status === 'Chờ lấy hàng') {
                    actions = `<button class="rental-action-btn bg-blue-600/80 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded" data-id="${doc.id}" data-action="handover">Bàn giao</button>
                               <button class="rental-action-btn bg-red-600/80 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded ml-2" data-id="${doc.id}" data-action="cancel">Hủy</button>`;
                } else if (rental.status === 'Đang thuê') {
                    actions = `<button class="rental-action-btn bg-green-600/80 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded" data-id="${doc.id}" data-action="return">Nhận lại</button>`;
                }
                
                tableHTML += `<tr class="border-b border-gray-700 hover:bg-gray-700/50"><td class="p-4 font-medium">${rental.customer.name}</td><td class="p-4 text-gray-400">${formatDate(rental.startDate)}</td><td class="p-4 text-gray-400">${formatDate(rental.endDate)}</td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${rental.status}</span></td><td class="p-4 text-right font-semibold text-green-400">${formatCurrency(rental.actualCost !== undefined ? rental.actualCost : rental.totalCost)}</td><td class="p-4 text-center">${actions}</td></tr>`;
                
                mobileHTML += `<div class="bg-gray-800 rounded-lg shadow-md p-4 list-card" data-type="rental" data-id="${doc.id}"><div class="flex justify-between items-start"><div class="flex-grow"><p class="font-bold text-white">${rental.customer.name}</p><p class="text-sm text-gray-400">Trả: ${formatDate(rental.endDate)}</p></div><div class="flex-shrink-0 ml-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${rental.status}</span></div></div><div class="mt-4 flex justify-between items-center"><p class="text-green-400 font-semibold">${formatCurrency(rental.actualCost !== undefined ? rental.actualCost : rental.totalCost)}</p><div class="flex items-center space-x-2">${actions}</div></div></div>`;
            });
            rentalTableBody.innerHTML = tableHTML;
            rentalListMobile.innerHTML = mobileHTML;
        }
        rentalListMobile.addEventListener('click', async (e) => {
            const card = e.target.closest('.list-card');
            const isActionButton = e.target.closest('.rental-action-btn');
            if (card && !isActionButton) {
                const id = card.dataset.id;
                const docRef = doc(db, 'rentals', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const rental = docSnap.data();
                    let itemsHTML = rental.items.map(item => `<p class="pl-4">- ${item.name} (S/N: ${item.serialNumber})</p>`).join('');
                    const content = `
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Khách hàng:</span><span class="font-semibold">${rental.customer.name} (${rental.customer.phone})</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Ngày thuê:</span><span class="font-semibold">${formatDate(rental.startDate, true)}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Ngày trả:</span><span class="font-semibold">${formatDate(rental.endDate, true)}</span></div>
                        <div class="py-2 border-b border-gray-700"><span>Thiết bị thuê:</span><div class="text-sm mt-1">${itemsHTML}</div></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Chi phí dự kiến:</span><span class="font-semibold">${formatCurrency(rental.totalCost)}</span></div>
                        <div class="flex justify-between py-2 border-b border-gray-700"><span>Trạng thái:</span><span class="font-semibold">${rental.status}</span></div>
                        ${rental.actualCost !== undefined ? `<div class="flex justify-between py-2 border-b border-gray-700"><span>Thực thu:</span><span class="font-bold text-green-400">${formatCurrency(rental.actualCost)}</span></div>` : ''}
                        ${rental.adjustmentNotes ? `<div class="py-2"><span>Ghi chú:</span><p class="text-sm italic text-gray-400">${rental.adjustmentNotes}</p></div>` : ''}
                    `;
                    openDetailsModal('Chi tiết đơn thuê', content);
                }
            }
        });
        async function handleRentalAction(rentalId, action) {
            const rentalRef = doc(db, 'rentals', rentalId);
            const rentalSnap = await getDoc(rentalRef);
            if (!rentalSnap.exists()) return;
            const rentalData = rentalSnap.data();
            rentalData.id = rentalId;

            if (action === 'return') {
                openReturnModal(rentalData);
                return;
            }

            const batch = writeBatch(db);
            if (action === 'handover') {
                batch.update(rentalRef, { status: 'Đang thuê' });
                rentalData.items.forEach(item => batch.update(doc(db, 'equipment', item.id), { status: 'Đang được thuê' }));
                logActivity(`Đã bàn giao đơn cho ${rentalData.customer.name}`);
            } else if (action === 'cancel') {
                 if (!confirm('Bạn có chắc muốn hủy đơn thuê này? Các thiết bị sẽ được trả về trạng thái "Sẵn có".')) return;
                batch.delete(rentalRef);
                rentalData.items.forEach(item => batch.update(doc(db, 'equipment', item.id), { status: 'Sẵn có' }));
                logActivity(`Đã hủy đơn thuê của ${rentalData.customer.name}`);
            }
            await batch.commit();
        }
        rentalTableBody.addEventListener('click', (e) => { const btn = e.target.closest('.rental-action-btn'); if (btn) handleRentalAction(btn.dataset.id, btn.dataset.action); });
        rentalListMobile.addEventListener('click', (e) => { const btn = e.target.closest('.rental-action-btn'); if (btn) handleRentalAction(btn.dataset.id, btn.dataset.action); });

        // --- Return Modal Logic ---
        function openReturnModal(rentalData) {
            activeReturnData = rentalData;
            returnForm.reset();
            returnFormError.textContent = '';
            
            const startDate = rentalData.startDate.toDate();
            const actualReturnDate = new Date();

            const dailyRateTotal = rentalData.items.reduce((sum, item) => sum + item.dailyRate, 0);
            
            const diffTime = Math.abs(actualReturnDate - startDate);
            const actualDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
            
            const systemCalculatedCost = dailyRateTotal * actualDays;
            const difference = systemCalculatedCost - rentalData.totalCost;

            let differenceHTML = '';
            if (difference > 0) {
                differenceHTML = `<div class="flex justify-between text-red-400"><p>Phí trả muộn:</p><p class="font-semibold">${formatCurrency(difference)}</p></div>`;
            } else if (difference < 0) {
                differenceHTML = `<div class="flex justify-between text-green-400"><p>Giảm giá trả sớm:</p><p class="font-semibold">${formatCurrency(difference)}</p></div>`;
            }

            returnInfoDiv.innerHTML = `<p class="font-bold text-lg">${rentalData.customer.name}</p><div class="p-3 bg-gray-700/50 rounded-lg space-y-2 text-sm"><div class="flex justify-between"><p>Ngày thuê:</p><p class="font-semibold">${formatDate(rentalData.startDate, true)}</p></div><div class="flex justify-between"><p>Ngày trả dự kiến:</p><p class="font-semibold">${formatDate(rentalData.endDate, true)}</p></div><div class="flex justify-between"><p>Ngày trả thực tế:</p><p class="font-semibold">${actualReturnDate.toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p></div><hr class="border-gray-600"><div class="flex justify-between"><p>Chi phí dự kiến:</p><p class="font-semibold">${formatCurrency(rentalData.totalCost)}</p></div><div class="flex justify-between"><p>Số ngày thuê thực tế:</p><p class="font-semibold">${actualDays} ngày</p></div>${differenceHTML}<hr class="border-gray-600"><div class="flex justify-between font-bold text-lg"><p>Tổng tiền (hệ thống):</p><p>${formatCurrency(systemCalculatedCost)}</p></div></div>`;

            finalCostInput.value = systemCalculatedCost;
            finalCostInput.dataset.systemCost = systemCalculatedCost;
            adjustmentAmountInput.value = '';
            adjustmentNotesInput.value = '';

            confirmReturnModal.classList.remove('hidden');
            confirmReturnModal.classList.add('flex');
        }

        function calculateFinalCost() {
            const systemCost = parseFloat(finalCostInput.dataset.systemCost);
            const adjustment = parseFloat(adjustmentAmountInput.value) || 0;
            finalCostInput.value = systemCost + adjustment;
        }
        adjustmentAmountInput.addEventListener('input', calculateFinalCost);

        function closeReturnModal() { confirmReturnModal.classList.add('hidden'); confirmReturnModal.classList.remove('flex'); activeReturnData = null; }
        document.getElementById('close-return-modal-btn').addEventListener('click', closeReturnModal);
        document.getElementById('cancel-return-modal-btn').addEventListener('click', closeReturnModal);
        
        returnForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activeReturnData) return;
            returnFormError.textContent = '';
            const finalCostValue = parseFloat(finalCostInput.value);
            if (isNaN(finalCostValue)) {
                returnFormError.textContent = 'Tổng thu cuối cùng không hợp lệ.';
                return;
            }

            const batch = writeBatch(db);
            const rentalRef = doc(db, 'rentals', activeReturnData.id);
            
            batch.update(rentalRef, {
                status: 'Đã trả',
                returnedDate: serverTimestamp(),
                actualCost: finalCostValue,
                adjustmentAmount: parseFloat(adjustmentAmountInput.value) || 0,
                adjustmentNotes: adjustmentNotesInput.value.trim()
            });

            activeReturnData.items.forEach(item => {
                const eqRef = doc(db, 'equipment', item.id);
                batch.update(eqRef, { status: 'Sẵn có' });
            });

            await batch.commit();
            logActivity(`Đã nhận lại đơn từ ${activeReturnData.customer.name} với tổng thu ${formatCurrency(finalCostValue)}`);
            closeReturnModal();
        });


        // --- Rental Modal Logic ---
        function resetRentalState() { rentalState = { customer: null, items: [], startDate: null, endDate: null, totalCost: 0, days: 0 }; }
        function updateRentalUI() {
            if (rentalState.customer) { selectedCustomerInfo.innerHTML = `<p class="font-bold">${rentalState.customer.name} - ${rentalState.customer.phone}</p>`; selectedCustomerInfo.classList.remove('hidden'); } else { selectedCustomerInfo.classList.add('hidden'); }
            rentalCartDiv.innerHTML = rentalState.items.map((item, index) => `<div class="flex justify-between items-center p-2 bg-gray-700 rounded-md"><div><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-400">S/N: ${item.serialNumber}</p></div><div class="text-right"><p class="font-semibold">${formatCurrency(item.dailyRate)}</p><button class="remove-cart-item-btn text-red-400 text-xs" data-index="${index}">Xóa</button></div></div>`).join('');
            if (rentalState.days > 0 && rentalState.items.length > 0) { rentalSummaryDiv.classList.remove('hidden'); rentalDaysEl.textContent = `${rentalState.days} ngày`; rentalTotalCostEl.textContent = formatCurrency(rentalState.totalCost); } else { rentalSummaryDiv.classList.add('hidden'); }
            saveRentalBtn.disabled = !(rentalState.customer && rentalState.items.length > 0 && rentalState.days > 0);
        }
        function calculateTotal() {
            if (!rentalState.startDate || !rentalState.endDate) { rentalState.days = 0; rentalState.totalCost = 0; } else {
                const start = new Date(rentalState.startDate); const end = new Date(rentalState.endDate);
                if (end < start) { rentalState.days = 0; rentalState.totalCost = 0; updateRentalUI(); return; }
                const diffTime = Math.abs(end - start); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                rentalState.days = diffDays === 0 ? 1 : diffDays;
                const dailyTotal = rentalState.items.reduce((sum, item) => sum + item.dailyRate, 0);
                rentalState.totalCost = dailyTotal * rentalState.days;
            }
            updateRentalUI();
        }
        customerSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length < 2) { customerSearchResults.classList.add('hidden'); return; }
            const customersRef = collection(db, "customers");
            const nameQuery = query(customersRef, where('fullName', '>=', searchTerm), where('fullName', '<=', searchTerm + '\uf8ff'));
            const phoneQuery = query(customersRef, where('phone', '>=', searchTerm), where('phone', '<=', searchTerm + '\uf8ff'));
            const [nameSnapshot, phoneSnapshot] = await Promise.all([getDocs(nameQuery), getDocs(phoneQuery)]);
            const results = {};
            nameSnapshot.forEach(doc => results[doc.id] = { id: doc.id, ...doc.data() }); phoneSnapshot.forEach(doc => results[doc.id] = { id: doc.id, ...doc.data() });
            customerSearchResults.innerHTML = Object.values(results).map(cus => `<div class="p-2 hover:bg-gray-500 cursor-pointer" data-id="${cus.id}">${cus.fullName} - ${cus.phone}</div>`).join('');
            customerSearchResults.classList.remove('hidden');
        });
        customerSearchResults.addEventListener('click', (e) => {
            const target = e.target.closest('div'); if (!target) return;
            const customerId = target.dataset.id; const customerName = target.textContent.split(' - ')[0]; const customerPhone = target.textContent.split(' - ')[1];
            rentalState.customer = { id: customerId, name: customerName, phone: customerPhone };
            customerSearchInput.value = ''; customerSearchResults.classList.add('hidden'); updateRentalUI();
        });
        
        async function findAndAddEquipment() {
            const sn = equipmentSearchInput.value.trim().toUpperCase(); if (!sn) return; equipmentSearchError.textContent = '';
            if (rentalState.items.some(item => item.serialNumber === sn)) { equipmentSearchError.textContent = 'Thiết bị này đã có trong đơn.'; return; }
            const q = query(collection(db, "equipment"), where("serialNumber", "==", sn));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { equipmentSearchError.textContent = 'Không tìm thấy thiết bị với S/N này.'; return; }
            const doc = querySnapshot.docs[0]; const eq = { id: doc.id, ...doc.data() };
            if (eq.status !== 'Sẵn có') { equipmentSearchError.textContent = `Thiết bị này đang ${eq.status}. Không thể cho thuê.`; return; }
            rentalState.items.push(eq); equipmentSearchInput.value = ''; calculateTotal(); equipmentSearchInput.focus();
        }
        equipmentSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); findAndAddEquipment(); } });
        addEquipmentToCartBtn.addEventListener('click', findAndAddEquipment);

        rentalCartDiv.addEventListener('click', (e) => { if (e.target.classList.contains('remove-cart-item-btn')) { const index = parseInt(e.target.dataset.index); rentalState.items.splice(index, 1); calculateTotal(); } });
        rentalForm.addEventListener('submit', async (e) => {
            e.preventDefault(); if (!rentalState.customer || rentalState.items.length === 0 || rentalState.days <= 0) return;
            const batch = writeBatch(db);
            const rentalRef = doc(collection(db, 'rentals'));
            batch.set(rentalRef, { customer: { id: rentalState.customer.id, name: rentalState.customer.name, phone: rentalState.customer.phone }, items: rentalState.items.map(({ id, serialNumber, name, dailyRate }) => ({ id, serialNumber, name, dailyRate })), startDate: new Date(rentalState.startDate), endDate: new Date(rentalState.endDate), totalCost: rentalState.totalCost, status: 'Chờ lấy hàng', createdAt: serverTimestamp() });
            rentalState.items.forEach(item => { const eqRef = doc(db, 'equipment', item.id); batch.update(eqRef, { status: 'Đã đặt trước' }); });
            await batch.commit();
            logActivity(`Đã tạo đơn thuê cho ${rentalState.customer.name}`);
            closeRentalModal();
        });
        function openRentalModal() {
            resetRentalState(); rentalForm.reset(); updateRentalUI(); rentalModal.classList.remove('hidden'); rentalModal.classList.add('flex');
            
            datePickerEnd = flatpickr(endDateInput, { enableTime: true, dateFormat: "Y-m-d H:i", onChange: (selectedDates) => { rentalState.endDate = selectedDates[0]; if (datePickerStart) { datePickerStart.set('maxDate', selectedDates[0]); } calculateTotal(); } });
            datePickerStart = flatpickr(startDateInput, { enableTime: true, dateFormat: "Y-m-d H:i", onChange: (selectedDates) => { const newStartDate = selectedDates[0]; rentalState.startDate = newStartDate; datePickerEnd.set('minDate', newStartDate); if (rentalState.endDate < newStartDate) { const adjustedEndDate = new Date(newStartDate); adjustedEndDate.setDate(adjustedEndDate.getDate() + 1); datePickerEnd.setDate(adjustedEndDate, true); } else { calculateTotal(); } } });
            
            const now = new Date();
            const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
            datePickerStart.setDate(now, true);
            datePickerEnd.setDate(tomorrow, true);
        }
        function closeRentalModal() { rentalModal.classList.add('hidden'); rentalModal.classList.remove('flex'); if(datePickerStart) datePickerStart.destroy(); if(datePickerEnd) datePickerEnd.destroy(); }
        addRentalBtn.addEventListener('click', openRentalModal);
        document.getElementById('close-rental-modal-btn').addEventListener('click', closeRentalModal);
        document.getElementById('cancel-rental-modal-btn').addEventListener('click', closeRentalModal);

        // --- Details Modal ---
        function openDetailsModal(title, content, type = null, id = null, name = null) {
            document.getElementById('details-modal-title').textContent = title;
            document.getElementById('details-modal-content').innerHTML = content;
            const actionsDiv = document.getElementById('details-modal-actions');
            if (type && id) {
                actionsDiv.innerHTML = `<button id="view-history-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg w-full">Xem lịch sử thuê</button>`;
                document.getElementById('view-history-btn').onclick = () => openHistoryModal(type, id, name);
            } else {
                actionsDiv.innerHTML = '';
            }
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex');
        }
        function closeDetailsModal() {
            detailsModal.classList.add('hidden');
            detailsModal.classList.remove('flex');
        }
        document.getElementById('close-details-modal-btn').addEventListener('click', closeDetailsModal);
        detailsModal.addEventListener('click', (e) => { if(e.target === detailsModal) closeDetailsModal(); });

        async function openHistoryModal(type, id, name) {
            closeDetailsModal(); // Close the current details modal
            let historyQuery;
            if (type === 'customer') {
                historyQuery = query(collection(db, 'rentals'), where('customer.id', '==', id), orderBy('createdAt', 'desc'));
            } else if (type === 'equipment') {
                // This query is more complex. We'll fetch all and filter client-side for simplicity in this MVP.
                // For production with large data, consider a different data structure.
                historyQuery = query(collection(db, 'rentals'), orderBy('createdAt', 'desc'));
            }

            const snapshot = await getDocs(historyQuery);
            let rentals = [];
            if (type === 'customer') {
                snapshot.forEach(doc => rentals.push(doc.data()));
            } else {
                snapshot.forEach(doc => {
                    const rental = doc.data();
                    if (rental.items.some(item => item.id === id)) {
                        rentals.push(rental);
                    }
                });
            }

            let content = `<p class="text-gray-400">Không có lịch sử thuê.</p>`;
            if (rentals.length > 0) {
                content = rentals.map(rental => {
                    const statusClass = getStatusClass(rental.status, 'rental');
                    return `<div class="p-3 bg-gray-700/50 rounded-lg">
                        <div class="flex justify-between">
                            <p class="font-semibold">${type === 'customer' ? `Đơn thuê ngày ${formatDate(rental.createdAt)}` : rental.customer.name}</p>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${rental.status}</span>
                        </div>
                        <p class="text-sm text-gray-400">Từ ${formatDate(rental.startDate)} đến ${formatDate(rental.endDate)}</p>
                    </div>`;
                }).join('');
            }
            openDetailsModal(`Lịch sử thuê của ${type === 'customer' ? name : `thiết bị ${name}`}`, content);
        }

        // --- Auth & Mobile UI Event Listeners ---
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value).catch(err => loginErrorEl.textContent = 'Email hoặc mật khẩu không đúng.'); });
        document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); if(registerForm['register-password'].value.length < 6) { registerErrorEl.textContent = 'Mật khẩu phải có ít nhất 6 ký tự.'; return; } createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value).catch(err => registerErrorEl.textContent = 'Email này đã tồn tại hoặc không hợp lệ.');});
        logoutButton.addEventListener('click', () => signOut(auth));
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); updateUI('register'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); updateUI('login'); });
        function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); sidebar.classList.toggle('translate-x-0'); sidebarOverlay.classList.toggle('hidden'); }
        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        // --- Initial Load ---
        updateUI('loading');
    </script>
</body>
</html>
